using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace _91_APP
{
    public partial class _91APP : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            string[] model = new string[] { "368040301200", "368040301224", "368040301225", "368040301235", "368040301237", "368040301239", "368040301241", "368040301243", "368040300265", "368040300279", "368040300280", "368040300363", "368040300364", "368040300365", "368040300366", "368040300367", "368040300368", "368040300369", "368040300370", "368040300371", "368040300372", "368040300292", "368040300293", "368040300294", "368040300295", "368040300296", "368040301110", "368040301201", "368040301222", "368040301223", "368040301236", "368040301238", "368040301240", "368040301242", "368040301244", "3680403001018", "368040300266", "368040300277", "368040300278", "368040300373", "368040300374", "368040300375", "368040300376", "368040300377", "368040300378", "368040300379", "368040300380", "368040300381", "368040300297", "368040300298", "368040300299", "368040300300", "368040300263", "368040300264", "368040301118", "368040301119", "368040301120", "368040301111", "368040301112", "368040301113", "368040301114", "368040301115", "368040301116", "368040301117", "368040300252", "368040300253", "368040300255", "368040300258", "368040300259", "368040300256", "368040300257", "368040300260", "368040300261", "368040300254", "368040300248", "368040300249", "368040300250", "368040300251", "3680403001292", "368040301377", "368040301378", "368040301379", "368040301380", "368040301381", "368040301382", "368040301383", "368040301392", "368040301384", "368040301385", "368040301393", "368040301394", "368040301395", "368040301386", "368040301396", "368040301387", "368040301397", "368040301398", "368040301399", "368040301400", "368040301401", "368040301402", "368040301388", "368040301389", "368040301390", "368040301391", "368040301403", "368040301404", "368040301405", "368040301406", "368040300239", "368040300209", "368040300208", "368040300985", "368040300986", "368040300213", "368040300214", "368040300215", "368040300216", "368040300217", "368040300218", "368040300219", "368040300220", "368040300221", "368040300222", "368040300223", "368040300224", "368040300225", "368040300226", "368040300227", "368040300228", "368040300229", "368040300230", "368040300231", "368040300232", "368040300233", "368040300234", "368040300235", "368040300236", "368040300237", "368040300238", "368040300240", "368040300241", "368040300242", "368040300243", "368040300245", "368040300247", "368040300210", "368040300211", "368040300212", "368040300355", "368040300983", "368040300984", "368040300987", "368040301336", "368040301337", "368040301338", "368040301346", "368040301347", "368040301351", "368040301339", "368040301340", "368040301348", "368030601541", "368040301341", "368040301342", "368040301349", "368040301343", "368040301350", "368040301344", "368040301345", "368040301352", "368040300281", "368040301974", "368040300981", "368040301353", "368040301354", "368040301355", "368040300982", "368040301356", "368040300268", "368040300302", "368040301357", "368040301358", "368040300269", "368040300267", "368040301364", "368040300276", "3680403001186", "368040301359", "368040301360", "368040301361", "368040301362", "368040301363", "368040301365", "368040300181", "368040300182", "368040301372", "368040301373", "368040300183", "368040301374", "368040300184", "368040301366", "368040301367", "368040301375", "368040301368", "368040301376", "368040300185", "368040301369", "368040301370", "368040300186", "368040301371", "368040300187", "368040300188", "368040301183", "368040301088", "368040301089", "368040301094", "368040301095", "368040301090", "368040301091", "368040301092", "368040301093", "368040301096", "368040301097", "368040301098", "368040301099", "368040301087", "368040301082", "368040301084", "368040301085", "368040301086", "368040301100", "368040301101", "368040301102", "368040301103", "368040301104", "368040301105", "368040301106", "368040301107", "368040301321", "368040301322", "368040301323", "368040301324", "368040300317", "368040300316", "368040300318", "368040300319", "368040300320", "368040300321", "368040300322", "368040300323", "368040301108", "368040301109", "368040301161", "368040301139", "368040301140", "368040301141", "368040301142", "368040301144", "368040301145", "368040301146", "368040301143", "368040300136", "368040301165", "368040301166", "368040301163", "368040301164", "368040301158", "368040301159", "368040301160", "368040301162", "368040301150", "368040301151", "368040301174", "368040301152", "368040301157", "368040301153", "368040301155", "368040301156", "368040301149", "368040301167", "368040301168", "368040301147", "368040301148", "368040301154", "368040301175", "368040300398", "368040201176", "368040300972", "368040300973", "368040300971", "368040300988", "368040301185", "368040301184", "368040301246", "368030602017", "368040201250", "368040301202", "368030602014", "368040300979", "368040301169", "368040300978", "368040301221", "368040301214", "368040301217", "368040301234", "368040301170", "368040301215", "368040301216", "368040301245", "368040300137", "368040301205", "368040300974", "368040300975", "368031000799", "368040301226", "368040300148", "368040301172", "368040301227", "368040301230", "368040300976", "368040301171", "368040300138", "368040301228", "368040301218", "368040301219", "368040301220", "368040300989", "368040300990", "368040300977", "368040300275", "368040301210", "368040300991", "368040301229", "368040301247", "368040301173", "3680403001124", "368040301206", "3680403001100", "368040301207", "368040301198", "368040301203", "368040301204", "368040301186", "368040301187", "368040301188", "368040301208", "368040301197", "368040301199", "368040301189", "368040301233", "368040201177", "368040301178", "368040301179", "368040301180", "368040301181", "368040301213", "368040301212", "368040301182", "368040301231", "368040301209", "368040301232", "368040301288", "368040301266", "368040301267", "368040301268", "368040301289", "368040301269", "368040301270", "368040301272", "368040301273", "368040301274", "368040301276", "368040301277", "368040301278", "368040301271", "368040301275", "368040301290", "368040301291", "368040301292", "368040301293", "368040301294", "368040301295", "368040301279", "368040301280", "368040301281", "368040301282", "368040301283", "368040301296", "368040301297", "368040301284", "368040301251", "368040301252", "368040301285", "368040301258", "368040301259", "368040301260", "368040301261", "368040301262", "368040301263", "368040301264", "368040301265", "368040301298", "368040301299", "368040301300", "368040301301", "368040301302", "368040301304", "368040301305", "368040301307", "368040301308", "368040301310", "368040301311", "368040301313", "368040301303", "368040301306", "368040301309", "368040301312", "368040301314", "368040301315", "368040301316", "368040301317", "368040301318", "368040301319", "368040301320", "368040301253", "368040301254", "368040301255", "368040301256", "368040301257", "368040301286", "368040301287" };
            var model2 = new long[] { 368090600112, 368040301063, 368040301064};
            string dirname = "五金工具";
            //var sortedWords =
            //    from w in model
            //    orderby model
            //    select w;
            //foreach (var h in sortedWords)
            //{
            //    Response.Write(h + ",");
            //}
            //int I=0;
            //Response.Write((Convert.ToChar(65 + I)).ToString());
            KH(model,model2,dirname);
        }

        private void KH(string[] model,long[] model2,string dirname)
        {
            //DataSet dssql = new DataSet();//產生資料集
            //DataTable dtsql = new DataTable();
            //dtsql.TableName = "91APPtable";
            //dtsql.Columns.Add("productname");
            //dtsql.Columns.Add("price1");
            //dtsql.Columns.Add("price2");
            //dtsql.Columns.Add("cost");
            //dtsql.Columns.Add("meta_key_word");
            //dtsql.Columns.Add("status");
            //dtsql.Columns.Add("product_depiction");
            //dtsql.Columns.Add("pic1");
            //dtsql.Columns.Add("pic2");
            //dtsql.Columns.Add("pic3");
            //dtsql.Columns.Add("pic4");
            //dtsql.Columns.Add("pic5");
            //dtsql.Columns.Add("pic6");
            //dtsql.Columns.Add("pic7");
            //dtsql.Columns.Add("pic8");
            //dtsql.Columns.Add("pic9");
            //dtsql.Columns.Add("pic10");
            //dssql.Tables.Add(dtsql);
            using(icshopc_icshopcEntities ent=new icshopc_icshopcEntities())
            {
                var v = (from product in ent.products
                         //join pmi     in ent.products_more_images on product.products_id equals pmi.products_id
                         //join pd in ent.products_description on product.products_id equals pd.products_id
                         join Ss in ent.shipping_status on product.products_shippingtime equals Ss.shipping_status_id
                         where Ss.language_id == 1 && product.products_status == true &&
                         model.Contains(product.products_model)
                         select new temp
                         {
                             products_id = product.products_id,
                             products_image=product.products_image,
                             products_model=product.products_model
                             //product.products_price,
                             //product.products_storage_spaces,
                             //pd.products_name,
                             //pd.products_meta_keywords,
                             //Ss.shipping_status_name
                         }).ToArray();
                
                foreach(var h in v)
                {
                    //Response.Write(h.products_id + ","+h.products_image);
                    if (String.IsNullOrEmpty(h.products_image))
                    {
                        Response.Write("," + h.products_id + "沒有圖片,");
                    }
                    else
                    {
                        Uri uri = new Uri("http://www.icshop.com.tw/images/product_images/original_images/" + h.products_image);
                        string saveDir = @"C:\91APP\" + dirname + "\\";    // 注意：資料夾必須已存在
                        string fileName = h.products_model+"A.jpg";
                        string savePath = saveDir + fileName;
                        System.Net.WebRequest request = System.Net.WebRequest.Create(uri);
                        System.Net.WebResponse response = request.GetResponse();
                        System.IO.Stream stream = response.GetResponseStream();
                        System.Drawing.Image img = System.Drawing.Image.FromStream(stream);
                        if (Directory.Exists(saveDir))
                        {
                            img.Save(savePath);
                        }
                        else
                        {
                            //新增資料夾
                            Directory.CreateDirectory(saveDir);
                            img.Save(savePath);
                        }
                    }
                    var c = from pmi in ent.products_more_images where pmi.products_id == h.products_id select new {pmi.image_name};
                    int I = 1;
                    foreach(var cc in c)
                    {
                        Uri uri = new Uri("http://www.icshop.com.tw/images/product_images/original_images/" + cc.image_name);
                        string saveDir = @"C:\91APP\" + dirname + "\\";    // 注意：資料夾必須已存在
                        string fileName = h.products_model + (Convert.ToChar(65 + I)).ToString()+".jpg";
                        string savePath = saveDir + fileName;
                        System.Net.WebRequest request = System.Net.WebRequest.Create(uri);
                        System.Net.WebResponse response = request.GetResponse();
                        System.IO.Stream stream = response.GetResponseStream();
                        System.Drawing.Image img = System.Drawing.Image.FromStream(stream);
                        if (Directory.Exists(saveDir))
                        {
                            img.Save(savePath);
                        }
                        else
                        {
                            //新增資料夾
                            Directory.CreateDirectory(saveDir);
                            img.Save(savePath);
                        }
                        I++;
                    }
                }
                Response.Write("抓完啦啦");
            }

        }
        public class temp
        {
            public int products_id;
            public string products_image;
            public string products_model;
        }
    }
}